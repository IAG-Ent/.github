name: Pytest
description: Runs a pytest in the given dir
inputs:
  aws_role:
    description: 'AWS OIDC Role'
    required: true
  working_dir:
    description: 'Directory where tests live'
    required: true
  python_version_matrix:
    description: 'Lst of python versions'
    required: true

runs:
  using: "composite"
  steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Set up Python ${{ inputs.python_version_matrix }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ inputs.python_version_matrix }}
    - name: Install testing dependencies
      shell: bash
      run: |
        python -m pip install --upgrade pip
        pip install black pytest

    - name: Set up Python environments
      shell: bash
      working-directory: ${{ inputs.working_dir }}
      run: |

        pip install pytest black

        # Lint with black
        black . --check

        python3 -m venv venv
        source venv/bin/activate

        if [ -f "requirements.txt" ]; then
          pip install -r requirements.txt
        else
          echo "No requirements.txt found in test dir, skipping."
        fi

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-region: eu-west-1
        role-to-assume: ${{ inputs.aws_role }}
        role-session-name: IntegrationTests
    - name: Run Pytest
      shell: bash
      working-directory: ${{ inputs.integration_tests }}
      run: |
        source venv/bin/activate

        pytest .

        deactivate