name: Lambda Tests and Package
description: Runs a pytest in the given dir
inputs:
  INTG_TEST_DIR:
    description: 'INTG_TEST_DIR'
    required: true
  AWS_OIDC_ROLE:
    description: 'AWS_OIDC_ROLE'
    required: true

runs:
  using: "composite"
  steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Set up Python ${{ inputs.python_version_matrix }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ inputs.python_version_matrix }}
    - name: Install testing dependencies
      shell: bash
      run: |
        python -m pip install --upgrade pip
        pip install black pytest

    - name: Set up Python environments
      shell: bash
      working-directory: "${{inputs.INTG_TEST_DIR}}"
      run: |

        pip install pytest black

        # Lint with black
        black . --check

        python3 -m venv venv

        if [ -f "requirements.txt" ]; then
          pip install -r requirements.txt
        else
          echo "No requirements.txt found in test dir, skipping."
        fi

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-region: eu-west-1
        role-to-assume: ${{ inputs.AWS_OIDC_ROLE }}
        role-session-name: IntegrationTests
    - name: Run Pytest
      shell: bash
      working-directory: "${{inputs.INTG_TEST_DIR}}"
      run: |
        source ./venv/bin/activate

        pytest .

        deactivate